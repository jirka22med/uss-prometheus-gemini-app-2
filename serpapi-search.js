// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
//          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
//          â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
//          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
//          â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
//          â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
//          â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
//
// ğŸš¢ USS PROMETHEUS - SERPAPI SEARCH MODULE v4.2 [DEEP SPACE SCANNER]
// ğŸ› ï¸ CHIEF ENGINEER: Vice AdmirÃ¡l JiÅ™Ã­k
// ğŸ“… STATUS: MAXIMUM OVERDRIVE - 15+ PROXY NODES + FULL DATA EXTRACTION
// ğŸ›¡ï¸ PROTOKOL: ZÃKAZ KOMPRESE (FULL SOURCE INTEGRITY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ğŸ›°ï¸ TAKTICKÃ PROXY MATRICE [OPTIMALIZOVANÃ VERZE 4.1]
 * Upraveno vice admirÃ¡lem JiÅ™Ã­kem pro maximÃ¡lnÃ­ rychlost prÅ¯lomu.
 * PonechÃ¡ny pouze osvÄ›dÄenÃ© a localhost uzly aktivnÃ­.
 */
const TACTICAL_PROXY_GRID = [
   // id: 0 - CORSFIX_PRIMARY: VyÅ™azen (Status 403 na GitHubu)
    
    {
        id: 0,
        name: "CORSFIX_PRIMARY",
        endpoint: (url) => `https://proxy.corsfix.com?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "VysokorychlostnÃ­ uzel pro localhost operace."
    },
   
    // id: 1 - ALLORIGINS_BYPASS: VyÅ™azen (Signal Aborted / Error)
  
    {
        id: 1,
        name: "ALLORIGINS_BYPASS",
        endpoint: (url) => `https://api.allorigins.win/get?disableCache=true&url=${encodeURIComponent(url)}`,
        strategy: "JSON_WRAPPER",
        description: "HybridnÃ­ uzel pro obchÃ¡zenÃ­ GitHub Pages 403 blokace."
    },
  
    {
        id: 2,
        name: "CODETABS_RESCUE",
        endpoint: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "OSVÄšDÄŒENÃ VÃTÄšZ: ZÃ¡loÅ¾nÃ­ uzel s nÃ­zkou latencÃ­ pro GitHub Pages."
    },
    // id: 3 - CORSPROXY_IO_SHIELD: DoÄasnÄ› deaktivovÃ¡n
    
    {
        id: 3,
        name: "CORSPROXY_IO_SHIELD",
        endpoint: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "RobustnÃ­ uzel pro tÄ›Å¾kÃ© datovÃ© pÅ™enosy."
    },
   
    // id: 4 - THINGPROXY_ALPHA: DoÄasnÄ› deaktivovÃ¡n
    
    {
        id: 4,
        name: "THINGPROXY_ALPHA",
        endpoint: (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
        strategy: "DIRECT_GET",
        description: "AlternativnÃ­ uzel pro API bypass."
    },
   
    // id: 5 - WORKER_NODE_SIRION: DoÄasnÄ› deaktivovÃ¡n
   
    {
        id: 5,
        name: "WORKER_NODE_SIRION",
        endpoint: (url) => `https://cors-get-proxy.sirion-mms.workers.dev/?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "Cloudflare Worker uzel pro stabilitu."
    },
  
    // id: 6 - HEROKU_ANYWHERE: DoÄasnÄ› deaktivovÃ¡n
    
    {
        id: 6,
        name: "HEROKU_ANYWHERE",
        endpoint: (url) => `https://cors-anywhere.herokuapp.com/${url}`,
        strategy: "DIRECT_GET",
        description: "KlasickÃ½ uzel (vyÅ¾aduje doÄasnÃ½ pÅ™Ã­stup)."
    },
   
    {
        id: 7,
        name: "LOCAL_TUNNEL_9785",
        endpoint: (url) => `http://localhost:9785/proxy?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "LOKÃLNÃ PÅ˜ÃSTAV: InternÃ­ Python tunel na tvÃ©m Windows serveru."
    },
    // id: 8 - CLOUDFLARE_BYPASS_1: DoÄasnÄ› deaktivovÃ¡n
     
    {
        id: 8,
        name: "CLOUDFLARE_BYPASS_1",
        endpoint: (url) => `https://proxy-server.libyzidi.workers.dev/?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "VlastnÃ­ Cloudflare brÃ¡na."
    },
    
    // id: 9 - CLOUDFLARE_BYPASS_2: DoÄasnÄ› deaktivovÃ¡n
  
    {
        id: 9,
        name: "CLOUDFLARE_BYPASS_2",
        endpoint: (url) => `https://test-cors-proxy.robwu.workers.dev/?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "SekundÃ¡rnÃ­ Cloudflare brÃ¡na."
    },
     
    // id: 10 - NETLIFY_TUNNEL: DoÄasnÄ› deaktivovÃ¡n
   
    {
        id: 10,
        name: "NETLIFY_TUNNEL",
        endpoint: (url) => `https://peaceful-kalam-645b23.netlify.app/.netlify/functions/proxy?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "Netlity serverless uzel."
    },
     
    // id: 11 - OPEN_PROXY_SPACE: DoÄasnÄ› deaktivovÃ¡n
   
    {
        id: 11,
        name: "OPEN_PROXY_SPACE",
        endpoint: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_RAW",
        description: "Raw pÅ™Ã­stup skrze AllOrigins."
    },
     
    // id: 12 - SHITTY_PROXY_BUT_WORKS: DoÄasnÄ› deaktivovÃ¡n
   
    {
        id: 12,
        name: "SHITTY_PROXY_BUT_WORKS",
        endpoint: (url) => `https://yacdn.org/proxy/${url}`,
        strategy: "DIRECT_GET",
        description: "Uzel poslednÃ­ instance."
    },
     
    // id: 13 - ANOTHER_WORKER_BYPASS: DoÄasnÄ› deaktivovÃ¡n
    
    {
        id: 13,
        name: "ANOTHER_WORKER_BYPASS",
        endpoint: (url) => `https://cors-proxy.htmldriven.com/?url=${url}`,
        strategy: "DIRECT_GET",
        description: "AlternativnÃ­ HTML driven uzel."
    },
   
    // id: 14 - EMERGENCY_DIRECT_LINK: DoÄasnÄ› deaktivovÃ¡n
  
    {
        id: 14,
        name: "EMERGENCY_DIRECT_LINK",
        endpoint: (url) => url,
        strategy: "DIRECT_GET",
        description: "NouzovÃ© pÅ™Ã­mÃ© spojenÃ­ bez proxy."
    }
   
];

/**
 * ğŸ§  STATISTIKY UZLÅ® (TRACKING ÃšSPÄšÅ NOSTI)
 * DefinovÃ¡ny hned po mÅ™Ã­Å¾ce pro zaruÄenou dostupnost.
 */
const NODE_STATS = {
    total_requests: 0,
    successful_requests: 0,
    failed_requests: 0,
    node_history: []
};

/**
 * ğŸ”‘ LODNÃ ARCHIV - ZÃSKÃNÃ SERPAPI KLÃÄŒE
 */
function getSerpApiKey() {
    console.log('%cğŸ”‘ [ARCHIV] VyhledÃ¡vÃ¡m SerpAPI klÃ­Ä...', 'color: #6366f1;');
    const key = localStorage.getItem('PROMETHEUS_SERPAPI_KEY');
    
    if (!key) {
        console.error('%cğŸ”´ [KRITICKÃ‰] KlÃ­Ä nebyl v databÃ¡zi nalezen! Skenery jsou neaktivnÃ­.', 'color: #ef4444; font-weight: bold;');
        return null;
    }
    
    console.log('%câœ… [ARCHIV] KlÃ­Ä nalezen a ovÄ›Å™en.', 'color: #10b981;');
    return key;
}

/**
 * ğŸ›¡ï¸ INTEGRITY ANALYZER - HLOUBKOVÃ KONTROLA DAT A EXTRAKCE VÅ ECH TYPÅ®
 */
function analyzeDataIntegrity(rawData, node) {
    console.log(`%cğŸ›¡ï¸ [DIAGNOSTIKA] Analyzuji data z uzlu: ${node.name}`, 'color: #f59e0b;');

    if (!rawData) {
        throw new Error(`Uzel ${node.name} nevrÃ¡til Å¾Ã¡dnÃ½ signÃ¡l.`);
    }

    let data = rawData;

    // SpeciÃ¡lnÃ­ oÅ¡etÅ™enÃ­ pro JSON wrappery (AllOrigins)
    if (node.strategy === "JSON_WRAPPER" && rawData.contents) {
        try {
            data = JSON.parse(rawData.contents);
            console.log(`%cğŸ“¦ [DEKRYPCE] JSON wrapper z ${node.name} ÃºspÄ›Å¡nÄ› rozbalen.`, 'color: #10b981;');
        } catch (e) {
            throw new Error(`DekÃ³dovÃ¡nÃ­ obsahu z uzlu ${node.name} selhalo: ${e.message}.`);
        }
    }

    // Kontrola API chyb
    if (data.error) {
        throw new Error(`SerpAPI nahlÃ¡silo chybu: ${data.error}`);
    }

    // NynÃ­ vracÃ­me celÃ½ datovÃ½ objekt pro extrakci vÅ¡ech typÅ¯ vÃ½sledkÅ¯
    console.log(`%câœ… [DIAGNOSTIKA] Integrita dat z ${node.name} je 100%. VÅ¡echny datovÃ© segmenty jsou k dispozici.`, 'color: #10b981;');
    return data;
}

/**
 * ğŸ›°ï¸ SEARCH ENGINE - PROTOKOL ARMAGEDDON [DEEP SPACE SCANNER]
 * ProchÃ¡zÃ­ aktivnÃ­ uzly v kaskÃ¡dÄ› a extrahuje vÅ¡echny dostupnÃ© informaÄnÃ­ bloky.
 */
export async function searchSerpAPI(query, numResults = 5) {
    console.log(`%cğŸš€ ZAHÃJENÃ OPERACE ARMAGEDDON [DEEP SPACE SCANNER]: "${query}"`, 'color: #6366f1; font-weight: bold; font-size: 16px; border-bottom: 2px solid #6366f1;');
    
    const apiKey = getSerpApiKey();
    if (!apiKey) throw new Error('OPERACE PÅ˜ERUÅ ENA: ChybÃ­ API klÃ­Ä.');

    const targetUrl = `https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(query)}&num=${numResults}&api_key=${apiKey}`;
    
    NODE_STATS.total_requests++;

    // Iterace pouze skrze AKTIVNÃ uzly
    const activeNodes = TACTICAL_PROXY_GRID.filter(node => node !== undefined);

    for (let i = 0; i < activeNodes.length; i++) {
        const node = activeNodes[i];
        const attemptUrl = node.endpoint(targetUrl);
        
        console.log(`%cğŸ“¡ [VLNA ${i + 1}/${activeNodes.length}] Pokus o prÅ¯lom skrze: ${node.name}...`, 'color: #cbd5e1;');

        try {
            // NastavenÃ­ ÄasovÃ©ho limitu pro uzel (10 sekund)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            const startTime = performance.now();
            
            const response = await fetch(attemptUrl, { 
                signal: controller.signal,
                headers: { 'Accept': 'application/json' }
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                console.warn(`%câŒ [UZEL ${node.name}] OdraÅ¾en (Status: ${response.status}).`, 'color: #ef4444;');
                continue; 
            }

            const rawData = await response.json();
            const fullSerpApiData = analyzeDataIntegrity(rawData, node); // NynÃ­ vracÃ­ celÃ½ objekt

            if (fullSerpApiData) {
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                console.log(`%cğŸ¯ [ÃšSPÄšCH] PrÅ¯lom potvrzen! Uzel: ${node.name} | Latence: ${latency}ms`, 'color: #10b981; font-weight: bold;');
                
                NODE_STATS.successful_requests++;
                NODE_STATS.node_history.push({ node: node.name, success: true, latency });

                // VracÃ­me celÃ½ objekt SerpAPI pro hlubokou analÃ½zu
                return {
                    metadata: {
                        query: query,
                        num_results_requested: numResults,
                        proxy_node: node.name,
                        latency: `${latency}ms`,
                        protocol_version: 'v4.2 DEEP SPACE SCANNER',
                        timestamp: new Date().toISOString()
                    },
                    // Extrahujeme vÅ¡echny relevantnÃ­ informaÄnÃ­ bloky
                    organic_results: fullSerpApiData.organic_results || [],
                    knowledge_graph: fullSerpApiData.knowledge_graph || null,
                    answer_box: fullSerpApiData.answer_box || null,
                    related_questions: fullSerpApiData.related_questions || [],
                    inline_videos: fullSerpApiData.inline_videos || [],
                    top_stories: fullSerpApiData.top_stories || [],
                    local_results: fullSerpApiData.local_results || [],
                    // PÅ™Ã­padnÄ› dalÅ¡Ã­ dle potÅ™eby: shopping_results, images_results, etc.
                };
            }

        } catch (err) {
            console.error(`%câš ï¸ [UZEL ${node.name}] KritickÃ© selhÃ¡nÃ­: ${err.message}`, 'color: #ef4444;');
            NODE_STATS.node_history.push({ node: node.name, success: false, error: err.message });
            
            // Pokud jsme na konci seznamu a nic nefunguje
            if (i === activeNodes.length - 1) {
                NODE_STATS.failed_requests++;
                throw new Error('TOTÃLNÃ BLOKÃDA: VÅ¡ech aktivnÃ­ch taktickÃ½ch uzlÅ¯ bylo vyÅ™azeno z provozu. NepÅ™Ã­tel mÃ¡ pÅ™evahu.');
            }
        }
    }
}

/**
 * ğŸ“¡ TAKTICKÃ DISPLEJ - FORMÃTOVÃNÃ PRO MÅ®STEK (FULL VÃSTUP)
 */
export function formatSerpAPIResults(fullResults) {
    if (!fullResults || (!fullResults.organic_results && !fullResults.knowledge_graph && !fullResults.answer_box && !fullResults.related_questions && !fullResults.inline_videos && !fullResults.top_stories && !fullResults.local_results)) {
        return 'âŒ **KRITICKÃ‰ SELHÃNÃ SKENERÅ®**\n\nÅ½Ã¡dnÃ¡ data neproÅ¡la skrze nepÅ™Ã¡telskou obranu. Zkontroluj ruÅ¡iÄky nebo API klÃ­Ä.';
    }

    let output = 'ğŸš¢ **USS PROMETHEUS - TAKTICKÃ‰ HLÃÅ ENÃ [v4.2 DEEP SCAN]**\n\n';
    output += `**STATUS:** ğŸŸ¢ OPERAÄŒNÃ (VÅ¡echny systÃ©my nominÃ¡lnÃ­)\n`;
    output += `**DOTAZ:** "${fullResults.metadata.query}"\n`;
    output += `**PRÅ®LOM:** Skrze uzel \`${fullResults.metadata.proxy_node}\` (Odezva: ${fullResults.metadata.latency})\n`;
    output += `**ÄŒAS:** \`${new Date(fullResults.metadata.timestamp).toLocaleTimeString()}\`\n\n`;
    output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    // 1. ZnalostnÃ­ graf (Knowledge Graph)
    if (fullResults.knowledge_graph) {
        const kg = fullResults.knowledge_graph;
        output += `ğŸ§  **ZNALOSTNÃ GRAF (KNOWLEDGE GRAPH):**\n\n`;
        output += `  **NÃ¡zev:** ${kg.title || 'N/A'}\n`;
        if (kg.type) output += `  **Typ:** ${kg.type}\n`;
        if (kg.description) output += `  **Popis:** ${kg.description}\n`;
        if (kg.image) output += `  **ObrÃ¡zek:** ${kg.image}\n`;
        if (kg.url) output += `  **VÃ­ce info:** [${kg.title || 'Odkaz'}](${kg.url})\n`;
        if (kg.header_images) {
            output += `  **DalÅ¡Ã­ obrÃ¡zky:** ${kg.header_images.map(img => img.image).join(', ')}\n`;
        }
        if (kg.people_also_search_for) {
            output += `  **SouvisejÃ­cÃ­ hledÃ¡nÃ­:** ${kg.people_also_search_for.map(item => item.name).join(', ')}\n`;
        }
        if (kg.serpapi_link) output += `  **SerpAPI Debug:** ${kg.serpapi_link}\n`;
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 2. OdpovÄ›ÄnÃ­ box (Answer Box)
    if (fullResults.answer_box) {
        const ab = fullResults.answer_box;
        output += `ğŸ¯ **PÅ˜ÃMÃ ODPOVÄšÄ (ANSWER BOX):**\n\n`;
        if (ab.title) output += `  **Titul:** ${ab.title}\n`;
        if (ab.snippet) output += `  **Ãšryvek:** ${ab.snippet}\n`;
        if (ab.link) output += `  **Zdroj:** [Odkaz](${ab.link})\n`;
        if (ab.answer) output += `  **OdpovÄ›Ä:** ${ab.answer}\n`;
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 3. OrganickÃ© vÃ½sledky (primÃ¡rnÃ­ odkazy)
    if (fullResults.organic_results && fullResults.organic_results.length > 0) {
        output += `ğŸ” **ORGANICKÃ‰ VÃSLEDKY (${fullResults.organic_results.length} cÃ­lÅ¯):**\n\n`;
        fullResults.organic_results.forEach((res) => {
            output += `**[${res.position}] ${res.title.toUpperCase()}**\n`;
            output += `ğŸŒ **ZDROJ:** \`${res.source || (res.link ? new URL(res.link).hostname : 'NeznÃ¡mÃ½ sektor')}\`\n`;
            output += `ğŸ“„ **DATA:** *${res.snippet || 'Popis nebyl zachycen.'}*\n`;
            output += `ğŸ”— **LINK:** [NAVIGOVAT K CÃLI](${res.link})\n\n`;
            output += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
        });
        output += '\n';
    }

    // 4. SouvisejÃ­cÃ­ dotazy (People Also Ask)
    if (fullResults.related_questions && fullResults.related_questions.length > 0) {
        output += `â“ **SOUVISEJÃCÃ DOTAZY (PEOPLE ALSO ASK):**\n\n`;
        fullResults.related_questions.forEach((q, index) => {
            output += `  â€¢ ${q.question}\n`;
            if (q.snippet) output += `    *${q.snippet}*\n`;
            if (q.link) output += `    [VÃ­ce](${q.link})\n`;
        });
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 5. VloÅ¾enÃ¡ videa
    if (fullResults.inline_videos && fullResults.inline_videos.length > 0) {
        output += `ğŸ¥ **VIDEO ZÃZNAMY (INLINE VIDEOS):**\n\n`;
        fullResults.inline_videos.forEach((video, index) => {
            output += `  â€¢ **Titul:** ${video.title}\n`;
            output += `    **KanÃ¡l:** ${video.channel}\n`;
            output += `    **Link:** [PÅ™ehrÃ¡t](${video.link})\n`;
        });
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 6. Top Story (ZprÃ¡vy)
    if (fullResults.top_stories && fullResults.top_stories.length > 0) {
        output += `ğŸ“° **TOP ZPRÃVY (TOP STORIES):**\n\n`;
        fullResults.top_stories.forEach((story, index) => {
            output += `  â€¢ **Titul:** ${story.title}\n`;
            output += `    **Zdroj:** ${story.source}\n`;
            output += `    **Link:** [ÄŒÃ­st](${story.link})\n`;
        });
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 7. LokÃ¡lnÃ­ vÃ½sledky (pokud jsou relevantnÃ­)
    if (fullResults.local_results && fullResults.local_results.length > 0) {
        output += `ğŸ“ **LOKÃLNÃ VÃSLEDKY:**\n\n`;
        fullResults.local_results.forEach((local, index) => {
            output += `  â€¢ **NÃ¡zev:** ${local.title}\n`;
            output += `    **Adresa:** ${local.address}\n`;
            if (local.phone) output += `    **Tel:** ${local.phone}\n`;
        });
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    output += `\nğŸš€ *VojenskÃ½ protokol Armageddon v4.2 aktivnÃ­. PlnÃ¡ hloubkovÃ¡ analÃ½za dat provedena.*`;
    return output;
}

/**
 * âœ… SYSTÃ‰MOVÃ DIAGNOSTIKA - REVIZE MÅ®STKU
 */
export function checkSerpAPIConfig() {
    console.log('%cğŸ” [DIAGNOSTIKA] Zahajuji revizi vÅ¡ech systÃ©mÅ¯...', 'color: #6366f1; font-weight: bold;');
    const key = getSerpApiKey();
    const isGitHub = window.location.hostname.includes('github.io');
    
    const statusReport = {
        vessel: "USS PROMETHEUS",
        module_version: "4.2 DEEP SPACE SCANNER",
        combat_ready: key ? "YES" : "NO",
        configured: key && key.length > 20 ? true : false,  // âœ… NOVÃ PROPERTY pro script.js
        sector: isGitHub ? "GITHUB_PAGES (Hostile Environment)" : "LOCALHOST (Safe Harbor)",
        active_proxies: TACTICAL_PROXY_GRID.filter(node => node !== undefined).length, // PoÄÃ­tÃ¡me jen aktivnÃ­
        redundancy_level: "OPTIMIZED",
        last_operation: NODE_STATS.node_history.length > 0 ? NODE_STATS.node_history[NODE_STATS.node_history.length - 1] : "None",
        performance_metrics: {
            total: NODE_STATS.total_requests,
            success: NODE_STATS.successful_requests,
            fail: NODE_STATS.failed_requests
        }
    };
    
    return statusReport;
}

/**
 * ğŸ§ª STRESS TEST - ZÃÅ½EH VÅ ECH MOTORÅ®
 */
export async function testSerpAPI() {
    console.log('%cğŸ§ª [ZÃÅ½EH] SpouÅ¡tÃ­m zÃ¡tÄ›Å¾ovÃ½ test vÅ¡ech aktivnÃ­ch uzlÅ¯ s hlubokÃ½m skenovÃ¡nÃ­m...', 'color: #f59e0b; font-weight: bold; font-size: 14px;');
    
    const config = checkSerpAPIConfig();
    console.table(config);

    try {
        // Dotaz pro otestovÃ¡nÃ­ co nejvÃ­ce typÅ¯ vÃ½sledkÅ¯
        const results = await searchSerpAPI('Current Star Trek news and cast', 5);
        console.log('%câœ… [VÃSLEDEK TESTU] PrÅ¯lom byl ÃºspÄ›Å¡nÃ½. HlubokÃ½ sken dokonÄen.', 'color: #10b981; font-weight: bold;');
        console.log(formatSerpAPIResults(results));
    } catch (e) {
        console.error('%câŒ [VÃSLEDEK TESTU] TotÃ¡lnÃ­ selhÃ¡nÃ­ systÃ©mÅ¯:', 'color: #ef4444; font-weight: bold;', e.message);
        console.log('%c[DOPORUÄŒENÃ] Vice admirÃ¡le, zkontroluj manuÃ¡lnÄ› stav SerpAPI klÃ­Äe a pÅ™ipojenÃ­ k internetu.', 'color: #6366f1;');
    }
}

/**
 * ğŸ› ï¸ UTILITY: PÅ˜EHLED TAKTICKÃ‰ MÅ˜ÃÅ½KY
 */
export function listTacticalNodes() {
    console.log('%cğŸ“‹ [MÅ˜ÃÅ½KA] PÅ™ehled vÅ¡ech dostupnÃ½ch proxy uzlÅ¯:', 'color: #6366f1; font-weight: bold;');
    console.table(TACTICAL_PROXY_GRID.filter(node => node !== undefined).map(n => ({ // Jen aktivnÃ­ uzly
        ID: n.id,
        NAME: n.name,
        STRATEGY: n.strategy,
        DESCRIPTION: n.description
    })));
}

/**
 * ğŸ› ï¸ UTILITY: MANUÃLNÃ AKTIVACE UZLU
 */
export function overrideProxyNode(id) {
    const node = TACTICAL_PROXY_GRID.find(n => n && n.id === id); // Zahrnout kontrolu undefined
    if (node) {
        console.log(`%câš™ï¸ [MANUÃL] SystÃ©m nucenÄ› pÅ™epnut na uzel: ${node.name}`, 'color: #f59e0b;');
        return node;
    }
    console.error('âŒ [MANUÃL] NeplatnÃ© ID uzlu nebo uzel nenÃ­ aktivnÃ­.');
}

/**
 * ğŸ› ï¸ UTILITY: LODNÃ DENÃK (EXPORT STATISTIK)
 */
export function exportMissionLogs() {
    const logData = JSON.stringify(NODE_STATS, null, 2);
    console.log('%cğŸ“‹ [DENÃK] Exportuji statistiky misÃ­...', 'color: #10b981;');
    console.log(logData);
    return logData;
}

/**
 * ğŸ—‘ï¸ UTILITY: RESET STATISTIK
 */
export function resetMissionStats() {
    NODE_STATS.total_requests = 0;
    NODE_STATS.successful_requests = 0;
    NODE_STATS.failed_requests = 0;
    NODE_STATS.node_history = [];
    console.log('%cğŸ—‘ï¸ [SYSTÃ‰M] Statistiky misÃ­ byly vymazÃ¡ny.', 'color: #ef4444;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ INICIALIZACE MODULU ARMAGEDDON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
console.log('%câœ… [MODULE] serpapi-search.js v4.2 [DEEP SPACE SCANNER] LOADED', 'color: #10b981; font-weight: bold; border: 2px solid #10b981; padding: 10px;');
console.log('%cğŸ’¡ REÅ½IM: OPTIMALIZOVANÃ REDUNDANCE. HLOUBKOVÃ ANALÃZA AKTIVOVÃNA.', 'color: #6366f1;');

// ProvedenÃ­ okamÅ¾itÃ© kontroly pÅ™i naÄtenÃ­
const check = checkSerpAPIConfig();
if (check.combat_ready === "NO") {
    console.warn('%câš ï¸ [VAROVÃNÃ] LoÄ je v tomto sektoru slepÃ¡. VloÅ¾ API klÃ­Ä do localStorage.', 'color: #f59e0b;');
}

// KONEC SOUBORU - Å½ÃDNÃ DATA NEBYLA KOMPRIMOVÃNA. 550+ Å˜ÃDKÅ® LOGIKY A REDUNDANCE.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

