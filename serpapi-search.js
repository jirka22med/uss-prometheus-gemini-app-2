// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
//          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
//          â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
//          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
//          â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
//          â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
//          â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
//
// ğŸš¢ USS PROMETHEUS - SERPAPI SEARCH MODULE v4.3 [OPRAVENÃ VERZE]
// ğŸ› ï¸ CHIEF ENGINEER: Vice AdmirÃ¡l JiÅ™Ã­k + AdmirÃ¡l Claude
// ğŸ“… DATUM OPRAVY: 6.2.2026
// ğŸ›¡ï¸ ZMÄšNY: VÃ­ce aktivnÃ­ch proxy uzlÅ¯, lepÅ¡Ã­ error handling, diagnostika
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ğŸ›°ï¸ TAKTICKÃ PROXY MATRICE [OPTIMALIZOVANÃ VERZE 4.3 - OPRAVENO]
 * AKTIVOVÃNO VÃCE UZLÅ® PRO MAXIMÃLNÃ REDUNDANCI
 */
const TACTICAL_PROXY_GRID = [
    // âœ… ID:2 - CODETABS (OSVÄšDÄŒENÃ)
    {
        id: 2,
        name: "CODETABS_RESCUE",
        endpoint: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "OSVÄšDÄŒENÃ VÃTÄšZ: ZÃ¡loÅ¾nÃ­ uzel s nÃ­zkou latencÃ­ pro GitHub Pages."
    },
    
    // âœ… ID:3 - CORSPROXY.IO (REAKTIVOVÃNO)
    {
        id: 3,
        name: "CORSPROXY_IO_SHIELD",
        endpoint: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "RobustnÃ­ uzel pro tÄ›Å¾kÃ© datovÃ© pÅ™enosy."
    },
    
    // âœ… ID:4 - THINGPROXY (REAKTIVOVÃNO)
    {
        id: 4,
        name: "THINGPROXY_ALPHA",
        endpoint: (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
        strategy: "DIRECT_GET",
        description: "AlternativnÃ­ uzel pro API bypass."
    },
    
    // âœ… ID:7 - LOCALHOST (FUNGUJE!)
    {
        id: 7,
        name: "LOCAL_TUNNEL_7778",
        endpoint: (url) => `http://localhost:7778/proxy?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "LOKÃLNÃ PÅ˜ÃSTAV: InternÃ­ Python tunel na tvÃ©m Windows serveru."
    },
    
    // âœ… ID:8 - CLOUDFLARE BYPASS 1 (REAKTIVOVÃNO)
    {
        id: 8,
        name: "CLOUDFLARE_BYPASS_1",
        endpoint: (url) => `https://proxy-server.libyzidi.workers.dev/?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_GET",
        description: "VlastnÃ­ Cloudflare brÃ¡na."
    },
    
    // âœ… ID:1 - ALLORIGINS (REAKTIVOVÃNO S LEPÅ ÃM HANDLINGEM)
    {
        id: 1,
        name: "ALLORIGINS_BYPASS",
        endpoint: (url) => `https://api.allorigins.win/get?disableCache=true&url=${encodeURIComponent(url)}`,
        strategy: "JSON_WRAPPER",
        description: "HybridnÃ­ uzel pro obchÃ¡zenÃ­ GitHub Pages 403 blokace."
    },
    
    // âœ… ID:11 - ALLORIGINS RAW (NOVÃ)
    {
        id: 11,
        name: "OPEN_PROXY_SPACE",
        endpoint: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        strategy: "DIRECT_RAW",
        description: "Raw pÅ™Ã­stup skrze AllOrigins."
    }
];

/**
 * ğŸ§  STATISTIKY UZLÅ® (TRACKING ÃšSPÄšÅ NOSTI)
 */
const NODE_STATS = {
    total_requests: 0,
    successful_requests: 0,
    failed_requests: 0,
    node_history: []
};

/**
 * ğŸ”‘ LODNÃ ARCHIV - ZÃSKÃNÃ SERPAPI KLÃÄŒE
 */
function getSerpApiKey() {
    console.log('%cğŸ”‘ [ARCHIV] VyhledÃ¡vÃ¡m SerpAPI klÃ­Ä...', 'color: #6366f1;');
    const key = localStorage.getItem('PROMETHEUS_SERPAPI_KEY');
    
    if (!key) {
        console.error('%cğŸ”´ [KRITICKÃ‰] KlÃ­Ä nebyl v databÃ¡zi nalezen! Skenery jsou neaktivnÃ­.', 'color: #ef4444; font-weight: bold;');
        return null;
    }
    
    console.log('%câœ… [ARCHIV] KlÃ­Ä nalezen a ovÄ›Å™en.', 'color: #10b981;');
    return key;
}

/**
 * ğŸ›¡ï¸ INTEGRITY ANALYZER - HLOUBKOVÃ KONTROLA DAT A EXTRAKCE VÅ ECH TYPÅ®
 */
function analyzeDataIntegrity(rawData, node) {
    console.log(`%cğŸ›¡ï¸ [DIAGNOSTIKA] Analyzuji data z uzlu: ${node.name}`, 'color: #f59e0b;');

    if (!rawData) {
        throw new Error(`Uzel ${node.name} nevrÃ¡til Å¾Ã¡dnÃ½ signÃ¡l.`);
    }

    let data = rawData;

    // SpeciÃ¡lnÃ­ oÅ¡etÅ™enÃ­ pro JSON wrappery (AllOrigins)
    if (node.strategy === "JSON_WRAPPER" && rawData.contents) {
        try {
            data = JSON.parse(rawData.contents);
            console.log(`%cğŸ“¦ [DEKRYPCE] JSON wrapper z ${node.name} ÃºspÄ›Å¡nÄ› rozbalen.`, 'color: #10b981;');
        } catch (e) {
            throw new Error(`DekÃ³dovÃ¡nÃ­ obsahu z uzlu ${node.name} selhalo: ${e.message}.`);
        }
    }

    // Kontrola API chyb
    if (data.error) {
        throw new Error(`SerpAPI nahlÃ¡silo chybu: ${data.error}`);
    }

    // âœ… NOVÃ KONTROLA: Pokud nejsou Å¾Ã¡dnÃ© vÃ½sledky
    const hasResults = (
        (data.organic_results && data.organic_results.length > 0) ||
        data.knowledge_graph ||
        data.answer_box ||
        (data.related_questions && data.related_questions.length > 0) ||
        (data.inline_videos && data.inline_videos.length > 0) ||
        (data.top_stories && data.top_stories.length > 0)
    );

    if (!hasResults) {
        console.warn(`%câš ï¸ [DIAGNOSTIKA] Uzel ${node.name} vrÃ¡til prÃ¡zdnÃ© vÃ½sledky!`, 'color: #f59e0b;');
        throw new Error(`Å½Ã¡dnÃ© vÃ½sledky nenalezeny pÅ™es uzel ${node.name}`);
    }

    console.log(`%câœ… [DIAGNOSTIKA] Integrita dat z ${node.name} je 100%. Nalezeny validnÃ­ vÃ½sledky.`, 'color: #10b981;');
    return data;
}

/**
 * ğŸ›°ï¸ SEARCH ENGINE - PROTOKOL ARMAGEDDON [DEEP SPACE SCANNER]
 */
export async function searchSerpAPI(query, numResults = 5) {
    console.log(`%cğŸš€ ZAHÃJENÃ OPERACE ARMAGEDDON v4.3: "${query}"`, 'color: #6366f1; font-weight: bold; font-size: 16px; border-bottom: 2px solid #6366f1;');
    
    const apiKey = getSerpApiKey();
    if (!apiKey) throw new Error('OPERACE PÅ˜ERUÅ ENA: ChybÃ­ API klÃ­Ä.');

    const targetUrl = `https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(query)}&num=${numResults}&api_key=${apiKey}`;
    
    console.log(`%cğŸ“¡ [DEBUG] Target URL: ${targetUrl}`, 'color: #94a3b8;');
    
    NODE_STATS.total_requests++;

    // Iterace pouze skrze AKTIVNÃ uzly
    const activeNodes = TACTICAL_PROXY_GRID.filter(node => node !== undefined);
    
    console.log(`%cğŸ” [INFO] AktivnÃ­ uzly: ${activeNodes.length}`, 'color: #10b981;');
    activeNodes.forEach((node, i) => {
        console.log(`%c   [${i+1}] ID:${node.id} - ${node.name}`, 'color: #cbd5e1;');
    });

    for (let i = 0; i < activeNodes.length; i++) {
        const node = activeNodes[i];
        const attemptUrl = node.endpoint(targetUrl);
        
        console.log(`%cğŸ“¡ [VLNA ${i + 1}/${activeNodes.length}] Pokus o prÅ¯lom skrze: ${node.name} (ID:${node.id})...`, 'color: #cbd5e1;');
        console.log(`%c   Proxy URL: ${attemptUrl.substring(0, 100)}...`, 'color: #64748b;');

        try {
            // NastavenÃ­ ÄasovÃ©ho limitu pro uzel (15 sekund - zvÃ½Å¡eno)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            const startTime = performance.now();
            
            const response = await fetch(attemptUrl, { 
                signal: controller.signal,
                headers: { 'Accept': 'application/json' }
            });

            clearTimeout(timeoutId);

            console.log(`%c   Response Status: ${response.status} ${response.statusText}`, 
                response.ok ? 'color: #10b981;' : 'color: #ef4444;');

            if (!response.ok) {
                console.warn(`%câŒ [UZEL ${node.name}] OdraÅ¾en (Status: ${response.status}).`, 'color: #ef4444;');
                continue; 
            }

            const rawData = await response.json();
            console.log(`%c   Raw data received, size: ${JSON.stringify(rawData).length} bytes`, 'color: #94a3b8;');
            
            const fullSerpApiData = analyzeDataIntegrity(rawData, node);

            if (fullSerpApiData) {
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                console.log(`%cğŸ¯ [ÃšSPÄšCH!] PrÅ¯lom potvrzen! Uzel: ${node.name} (ID:${node.id}) | Latence: ${latency}ms`, 'color: #10b981; font-weight: bold; font-size: 14px;');
                
                NODE_STATS.successful_requests++;
                NODE_STATS.node_history.push({ node: node.name, nodeId: node.id, success: true, latency });

                // VracÃ­me celÃ½ objekt SerpAPI pro hlubokou analÃ½zu
                return {
                    metadata: {
                        query: query,
                        num_results_requested: numResults,
                        proxy_node: node.name,
                        proxy_node_id: node.id,
                        latency: `${latency}ms`,
                        protocol_version: 'v4.3 OPRAVENÃ VERZE',
                        timestamp: new Date().toISOString()
                    },
                    // Extrahujeme vÅ¡echny relevantnÃ­ informaÄnÃ­ bloky
                    organic_results: fullSerpApiData.organic_results || [],
                    knowledge_graph: fullSerpApiData.knowledge_graph || null,
                    answer_box: fullSerpApiData.answer_box || null,
                    related_questions: fullSerpApiData.related_questions || [],
                    inline_videos: fullSerpApiData.inline_videos || [],
                    top_stories: fullSerpApiData.top_stories || [],
                    local_results: fullSerpApiData.local_results || [],
                };
            }

        } catch (err) {
            const errorMsg = err.message || 'NeznÃ¡mÃ¡ chyba';
            console.error(`%câš ï¸ [UZEL ${node.name} ID:${node.id}] KritickÃ© selhÃ¡nÃ­: ${errorMsg}`, 'color: #ef4444;');
            console.error(`%c   Stack trace:`, 'color: #64748b;', err);
            NODE_STATS.node_history.push({ node: node.name, nodeId: node.id, success: false, error: errorMsg });
            
            // Pokud jsme na konci seznamu a nic nefunguje
            if (i === activeNodes.length - 1) {
                NODE_STATS.failed_requests++;
                
                console.error(`%câŒ [TOTÃLNÃ BLOKÃDA] VÅ¡ech ${activeNodes.length} aktivnÃ­ch uzlÅ¯ selhalo!`, 'color: #b91c1c; font-weight: bold; font-size: 14px;');
                console.error(`%cğŸ“‹ [HISTORIE POKUSÅ®]:`, 'color: #f59e0b;');
                NODE_STATS.node_history.forEach((h, idx) => {
                    const status = h.success ? 'âœ… ÃšSPÄšCH' : 'âŒ SELHÃNÃ';
                    console.error(`%c   ${idx+1}. ${h.node} (ID:${h.nodeId}) - ${status}${h.error ? ': ' + h.error : ''}`, 
                        h.success ? 'color: #10b981;' : 'color: #ef4444;');
                });
                
                throw new Error(`TOTÃLNÃ BLOKÃDA: VÅ¡ech ${activeNodes.length} aktivnÃ­ch taktickÃ½ch uzlÅ¯ bylo vyÅ™azeno z provozu. PoslednÃ­ chyba: ${errorMsg}`);
            }
        }
    }
}

/**
 * ğŸ“¡ TAKTICKÃ DISPLEJ - FORMÃTOVÃNÃ PRO MÅ®STEK (FULL VÃSTUP)
 */
export function formatSerpAPIResults(fullResults) {
    if (!fullResults || (!fullResults.organic_results && !fullResults.knowledge_graph && !fullResults.answer_box && !fullResults.related_questions && !fullResults.inline_videos && !fullResults.top_stories && !fullResults.local_results)) {
        return 'âŒ **KRITICKÃ‰ SELHÃNÃ SKENERÅ®**\n\nÅ½Ã¡dnÃ¡ data neproÅ¡la skrze nepÅ™Ã¡telskou obranu. Zkontroluj ruÅ¡iÄky nebo API klÃ­Ä.';
    }

    let output = 'ğŸš¢ **USS PROMETHEUS - TAKTICKÃ‰ HLÃÅ ENÃ [v4.3 OPRAVENO]**\n\n';
    output += `**STATUS:** ğŸŸ¢ OPERAÄŒNÃ (VÅ¡echny systÃ©my nominÃ¡lnÃ­)\n`;
    output += `**DOTAZ:** "${fullResults.metadata.query}"\n`;
    output += `**PRÅ®LOM:** Skrze uzel \`${fullResults.metadata.proxy_node}\` (ID:${fullResults.metadata.proxy_node_id}) (Odezva: ${fullResults.metadata.latency})\n`;
    output += `**ÄŒAS:** \`${new Date(fullResults.metadata.timestamp).toLocaleTimeString()}\`\n\n`;
    output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    // 1. ZnalostnÃ­ graf (Knowledge Graph)
    if (fullResults.knowledge_graph) {
        const kg = fullResults.knowledge_graph;
        output += `ğŸ§  **ZNALOSTNÃ GRAF (KNOWLEDGE GRAPH):**\n\n`;
        output += `  **NÃ¡zev:** ${kg.title || 'N/A'}\n`;
        if (kg.type) output += `  **Typ:** ${kg.type}\n`;
        if (kg.description) output += `  **Popis:** ${kg.description}\n`;
        if (kg.image) output += `  **ObrÃ¡zek:** ${kg.image}\n`;
        if (kg.url) output += `  **VÃ­ce info:** [${kg.title || 'Odkaz'}](${kg.url})\n`;
        if (kg.header_images) {
            output += `  **DalÅ¡Ã­ obrÃ¡zky:** ${kg.header_images.map(img => img.image).join(', ')}\n`;
        }
        if (kg.people_also_search_for) {
            output += `  **SouvisejÃ­cÃ­ hledÃ¡nÃ­:** ${kg.people_also_search_for.map(item => item.name).join(', ')}\n`;
        }
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 2. OdpovÄ›ÄnÃ­ box (Answer Box)
    if (fullResults.answer_box) {
        const ab = fullResults.answer_box;
        output += `ğŸ¯ **PÅ˜ÃMÃ ODPOVÄšÄ (ANSWER BOX):**\n\n`;
        if (ab.title) output += `  **Titul:** ${ab.title}\n`;
        if (ab.snippet) output += `  **Ãšryvek:** ${ab.snippet}\n`;
        if (ab.link) output += `  **Zdroj:** [Odkaz](${ab.link})\n`;
        if (ab.answer) output += `  **OdpovÄ›Ä:** ${ab.answer}\n`;
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 3. OrganickÃ© vÃ½sledky (primÃ¡rnÃ­ odkazy)
    if (fullResults.organic_results && fullResults.organic_results.length > 0) {
        output += `ğŸ” **ORGANICKÃ‰ VÃSLEDKY (${fullResults.organic_results.length} cÃ­lÅ¯):**\n\n`;
        fullResults.organic_results.forEach((res) => {
            output += `**[${res.position}] ${res.title.toUpperCase()}**\n`;
            output += `ğŸŒ **ZDROJ:** \`${res.source || (res.link ? new URL(res.link).hostname : 'NeznÃ¡mÃ½ sektor')}\`\n`;
            output += `ğŸ“„ **DATA:** *${res.snippet || 'Popis nebyl zachycen.'}*\n`;
            output += `ğŸ”— **LINK:** [NAVIGOVAT K CÃLI](${res.link})\n\n`;
            output += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
        });
        output += '\n';
    }

    // 4. SouvisejÃ­cÃ­ dotazy (People Also Ask)
    if (fullResults.related_questions && fullResults.related_questions.length > 0) {
        output += `â“ **SOUVISEJÃCÃ DOTAZY (PEOPLE ALSO ASK):**\n\n`;
        fullResults.related_questions.forEach((q) => {
            output += `  â€¢ ${q.question}\n`;
            if (q.snippet) output += `    *${q.snippet}*\n`;
            if (q.link) output += `    [VÃ­ce](${q.link})\n`;
        });
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    // 5. Top Story (ZprÃ¡vy)
    if (fullResults.top_stories && fullResults.top_stories.length > 0) {
        output += `ğŸ“° **TOP ZPRÃVY (TOP STORIES):**\n\n`;
        fullResults.top_stories.forEach((story) => {
            output += `  â€¢ **Titul:** ${story.title}\n`;
            output += `    **Zdroj:** ${story.source}\n`;
            output += `    **Link:** [ÄŒÃ­st](${story.link})\n`;
        });
        output += '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
    }

    output += `\nğŸš€ *VojenskÃ½ protokol Armageddon v4.3 OPRAVENO - PlnÃ¡ hloubkovÃ¡ analÃ½za dat provedena.*`;
    return output;
}

/**
 * âœ… SYSTÃ‰MOVÃ DIAGNOSTIKA - REVIZE MÅ®STKU
 */
export function checkSerpAPIConfig() {
    console.log('%cğŸ” [DIAGNOSTIKA] Zahajuji revizi vÅ¡ech systÃ©mÅ¯...', 'color: #6366f1; font-weight: bold;');
    const key = getSerpApiKey();
    const isGitHub = window.location.hostname.includes('github.io');
    
    const statusReport = {
        vessel: "USS PROMETHEUS",
        module_version: "4.3 OPRAVENÃ VERZE",
        combat_ready: key ? "YES" : "NO",
        configured: key && key.length > 20 ? true : false,
        sector: isGitHub ? "GITHUB_PAGES (Hostile Environment)" : "LOCALHOST (Safe Harbor)",
        active_proxies: TACTICAL_PROXY_GRID.filter(node => node !== undefined).length,
        redundancy_level: "MAXIMÃLNÃ - 7 UZLÅ®",
        last_operation: NODE_STATS.node_history.length > 0 ? NODE_STATS.node_history[NODE_STATS.node_history.length - 1] : "None",
        performance_metrics: {
            total: NODE_STATS.total_requests,
            success: NODE_STATS.successful_requests,
            fail: NODE_STATS.failed_requests
        }
    };
    
    console.table(statusReport);
    return statusReport;
}

/**
 * ğŸ§ª STRESS TEST - ZÃÅ½EH VÅ ECH MOTORÅ®
 */
export async function testSerpAPI() {
    console.log('%cğŸ§ª [ZÃÅ½EH] SpouÅ¡tÃ­m zÃ¡tÄ›Å¾ovÃ½ test vÅ¡ech aktivnÃ­ch uzlÅ¯...', 'color: #f59e0b; font-weight: bold; font-size: 14px;');
    
    const config = checkSerpAPIConfig();
    try {
        const results = await searchSerpAPI('Leden Ãºnor 2026 novinky', 5);
        console.log('%câœ… [VÃSLEDEK TESTU] PrÅ¯lom byl ÃºspÄ›Å¡nÃ½!', 'color: #10b981; font-weight: bold;');
        console.log(formatSerpAPIResults(results));
    } catch (e) {
        console.error('%câŒ [VÃSLEDEK TESTU] TotÃ¡lnÃ­ selhÃ¡nÃ­ systÃ©mÅ¯:', 'color: #ef4444; font-weight: bold;', e.message);
        console.log('%c[DOPORUÄŒENÃ] Vice admirÃ¡le, zkontroluj:\n1. SerpAPI klÃ­Ä v localStorage\n2. PÅ™ipojenÃ­ k internetu\n3. BÄ›Å¾Ã­cÃ­ Python proxy server (localhost:9785)\n4. Firewall nastavenÃ­', 'color: #6366f1;');
    }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ INICIALIZACE MODULU ARMAGEDDON v4.3
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
console.log('%câœ… [MODULE] serpapi-search.js v4.3 [OPRAVENÃ VERZE] LOADED', 'color: #10b981; font-weight: bold; border: 2px solid #10b981; padding: 10px;');
console.log('%cğŸ’¡ ZMÄšNY: 7 aktivnÃ­ch proxy uzlÅ¯, vylepÅ¡enÃ¡ diagnostika, lepÅ¡Ã­ error handling', 'color: #6366f1;');

// ProvedenÃ­ okamÅ¾itÃ© kontroly pÅ™i naÄtenÃ­
const check = checkSerpAPIConfig();
if (check.combat_ready === "NO") {
    console.warn('%câš ï¸ [VAROVÃNÃ] LoÄ je v tomto sektoru slepÃ¡. VloÅ¾ API klÃ­Ä do localStorage jako "PROMETHEUS_SERPAPI_KEY".', 'color: #f59e0b;');
}

// KONEC SOUBORU - OPRAVENÃ VERZE PRO VICE ADMIRÃLA JIÅ˜ÃKA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
